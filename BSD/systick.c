/**********************************************************************************************
Copyright 2008 - 2016 深圳市信盈达电子有限公司. All rights reserved.
描述   :     
作者   :       谢国卿
版本   :       V1.0
修改   :   
完成日期：     2017年9月26日
信盈达官网：http://www.edu118.com/
信盈达网校：http://www.edu118.cn/
信盈达技术论坛：http://bbs.edu118.com/
Notice    :本程序只供学习使用，未经作者许可，不得用于其它任何用途。版权所有，盗版必究
***********************************************************************************************/

/**********************************************************************************************
* INCLUDES
*/
#include "systick.h"
/**********************************************************************************************
* CONSTANTS
*/


/**********************************************************************************************
* TYPEDEFS
*/

/**********************************************************************************************
* LOCAL VARIABLES
*/


/**********************************************************************************************
* LOCAL FUNCTIONS  DECLARE
*/


/**********************************************************************************************
* LOCAL FUNCTIONS  
*/



/**********************************************************************************************
* PUBLIC FUNCTIONS
*/
/*******************************************************************
* 函数名：     Systick_Init()
* 功能描述 ：   初始化LED灯
* 作者：         谢国卿 
* 参数说明：     无
* 返回值说明：   无
* 修改记录：
* 其他：
*******************************************************************/

void Systick_Init(void)
{

}

/*******************************************************************
* 函数名：     delay_s()
* 功能描述 ：   延迟秒函数
* 作者：         谢国卿 
* 参数说明：     多少秒
* 返回值说明：   无
* 修改记录：
* 其他：
*******************************************************************/
void delay_s(u32 xs)
{
	SysTick->VAL=0;
	SysTick->LOAD=(72000000/8)*xs;
	SysTick->CTRL |=(1<<0); //开启计时
	while(!(SysTick->CTRL&(1<<16)));
	SysTick->CTRL &=~(1<<0); //禁止计时
}

/*******************************************************************
* 函数名：     delay_ms()
* 功能描述 ：   延迟毫秒函数
* 作者：         谢国卿 
* 参数说明：     多少毫秒
* 返回值说明：   无
* 修改人:		LukeLiu
* 修改记录：	共享锁定
* 其他：
*******************************************************************/
void delay_ms(u32 xms)
{
	if(SystickLock == 1)
	{
		if(SystickValueSave == 0)
		{
			SystickValueSave = SysTick->LOAD - SysTick->VAL;
		}
		else
		{
			
		}
		
		SysTick->VAL=0;
		SysTick->LOAD=(72000/8)*xms;
		SysTick->CTRL |=(1<<0); //开启计时
		while(!(SysTick->CTRL&(1<<16)));
		SysTick->CTRL &=~(1<<0); //禁止计时
		
		SysTick->VAL=0;
		SysTick->LOAD = SystickValueSave + 1;
		SysTick->CTRL |=(1<<0); //开启计时
		
		return ;
	}
	else
	{
		SystickLock = 1;
		
		SysTick->VAL=0;
		SysTick->LOAD=(72000/8)*xms;
		SysTick->CTRL |=(1<<0); //开启计时
		while(!(SysTick->CTRL&(1<<16)));
		SysTick->CTRL &=~(1<<0); //禁止计时
		
		SystickValueSave = 0;
		
		SystickLock = 0;
	}
	
	return ;
}

/*******************************************************************
* 函数名：     delay_us()
* 功能描述 ：   延迟微秒函数
* 作者：         谢国卿 
* 参数说明：     多少微秒
* 返回值说明：   无
* 修改记录：
* 其他：
*******************************************************************/
void delay_us(u32 xus)
{
//	
	
	if(SystickLock == 1)
	{
		if(SystickValueSave == 0)
		{
			SystickValueSave = SysTick->LOAD - SysTick->VAL;
		}
		else
		{
			
		}
		
		SysTick->VAL=0;
		SysTick->LOAD=(72/8)*xus;
		SysTick->CTRL |=(1<<0); //开启计时
		while(!(SysTick->CTRL&(1<<16)));
		SysTick->CTRL &=~(1<<0); //禁止计时
		
		SysTick->VAL=0;
		SysTick->LOAD = SystickValueSave + 1;
		SysTick->CTRL |=(1<<0); //开启计时
		
		return ;
	}
	else
	{
		SystickLock = 1;
		
		SysTick->VAL=0;
		SysTick->LOAD=(72/8)*xus;
		SysTick->CTRL |=(1<<0); //开启计时
		while(!(SysTick->CTRL&(1<<16)));
		SysTick->CTRL &=~(1<<0); //禁止计时
		
		SystickValueSave = 0;
		
		SystickLock = 0;
		
		return ;
	}
}

/***********************************************************************************************
***********************************************************************************************/
